name: Auto PR Creation

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'
      - 'develop'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    # åªåœ¨éä¸»åˆ†æ”¯æ¨é€æ—¶è¿è¡Œ
    if: github.ref != 'refs/heads/master' && github.ref != 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Extract branch info
        id: branch-info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # ç¡®å®šç›®æ ‡åˆ†æ”¯
          if [[ "$BRANCH_NAME" == feature/* ]] || [[ "$BRANCH_NAME" == fix/* ]]; then
            TARGET_BRANCH="develop"
          elif [[ "$BRANCH_NAME" == hotfix/* ]]; then
            TARGET_BRANCH="master"
          elif [[ "$BRANCH_NAME" == develop ]]; then
            TARGET_BRANCH="master"
          else
            TARGET_BRANCH="master"
          fi
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          
          # æå–åˆ†æ”¯ç±»å‹
          BRANCH_TYPE=$(echo "$BRANCH_NAME" | cut -d'/' -f1)
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT

      - name: Generate commit summary
        id: summary
        run: |
          # è·å–æœ€è¿‘çš„æäº¤
          COMMITS=$(git log origin/${{ steps.branch-info.outputs.target_branch }}..HEAD --pretty=format:"- %s (%h) - %an" --no-merges | head -20)
          
          # ç»Ÿè®¡æ›´æ”¹
          STATS=$(git diff origin/${{ steps.branch-info.outputs.target_branch }}..HEAD --shortstat)
          
          # è·å–æ›´æ”¹çš„æ–‡ä»¶
          CHANGED_FILES=$(git diff origin/${{ steps.branch-info.outputs.target_branch }}..HEAD --name-only | head -30)
          
          # ç»Ÿè®¡æ–‡ä»¶ç±»å‹
          GO_FILES=$(echo "$CHANGED_FILES" | grep '\.go$' | wc -l)
          TS_FILES=$(echo "$CHANGED_FILES" | grep '\.tsx\?$' | wc -l)
          JS_FILES=$(echo "$CHANGED_FILES" | grep '\.jsx\?$' | wc -l)
          
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "stats=$STATS" >> $GITHUB_OUTPUT
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "go_files=$GO_FILES" >> $GITHUB_OUTPUT
          echo "ts_files=$TS_FILES" >> $GITHUB_OUTPUT
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT

      - name: Determine PR labels
        id: labels
        run: |
          LABELS="automated"
          BRANCH_TYPE="${{ steps.branch-info.outputs.branch_type }}"
          
          case "$BRANCH_TYPE" in
            feature)
              LABELS="$LABELS,enhancement"
              ;;
            fix|hotfix)
              LABELS="$LABELS,bug"
              ;;
            develop)
              LABELS="$LABELS,release"
              ;;
          esac
          
          # æ ¹æ®æ–‡ä»¶ç±»å‹æ·»åŠ æ ‡ç­¾
          if [ ${{ steps.summary.outputs.go_files }} -gt 0 ]; then
            LABELS="$LABELS,backend"
          fi
          
          if [ ${{ steps.summary.outputs.ts_files }} -gt 0 ] || [ ${{ steps.summary.outputs.js_files }} -gt 0 ]; then
            LABELS="$LABELS,frontend"
          fi
          
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Generate PR emoji and title
        id: pr-title
        run: |
          BRANCH_TYPE="${{ steps.branch-info.outputs.branch_type }}"
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
          
          case "$BRANCH_TYPE" in
            feature)
              EMOJI="âœ¨"
              TITLE_PREFIX="Feature"
              ;;
            fix)
              EMOJI="ğŸ›"
              TITLE_PREFIX="Fix"
              ;;
            hotfix)
              EMOJI="ğŸš‘"
              TITLE_PREFIX="Hotfix"
              ;;
            develop)
              EMOJI="ğŸš€"
              TITLE_PREFIX="Release"
              ;;
            *)
              EMOJI="ğŸ”§"
              TITLE_PREFIX="Update"
              ;;
          esac
          
          # ä»æœ€åä¸€ä¸ªæäº¤ä¸­æå–æ ‡é¢˜
          LAST_COMMIT=$(git log -1 --pretty=%s)
          
          TITLE="$EMOJI $TITLE_PREFIX: $LAST_COMMIT"
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ steps.branch-info.outputs.branch_name }}`,
              base: '${{ steps.branch-info.outputs.target_branch }}',
              state: 'open'
            });
            
            return pulls.length > 0;
          result-encoding: string

      - name: Create Pull Request
        if: steps.check-pr.outputs.result == 'false'
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch-info.outputs.branch_name }}
          base: ${{ steps.branch-info.outputs.target_branch }}
          title: ${{ steps.pr-title.outputs.title }}
          body: |
            ## ${{ steps.pr-title.outputs.emoji }} è‡ªåŠ¨ç”Ÿæˆçš„æ‹‰å–è¯·æ±‚
            
            **æºåˆ†æ”¯**: `${{ steps.branch-info.outputs.branch_name }}`  
            **ç›®æ ‡åˆ†æ”¯**: `${{ steps.branch-info.outputs.target_branch }}`  
            **ç±»å‹**: `${{ steps.branch-info.outputs.branch_type }}`
            
            ---
            
            ### ğŸ“ æäº¤æ‘˜è¦
            
            ${{ steps.summary.outputs.commits }}
            
            ### ğŸ“Š å˜æ›´ç»Ÿè®¡
            
            ```
            ${{ steps.summary.outputs.stats }}
            ```
            
            **æ–‡ä»¶å˜æ›´ç»Ÿè®¡**:
            - Go æ–‡ä»¶: ${{ steps.summary.outputs.go_files }}
            - TypeScript æ–‡ä»¶: ${{ steps.summary.outputs.ts_files }}
            - JavaScript æ–‡ä»¶: ${{ steps.summary.outputs.js_files }}
            
            ### ğŸ“ å˜æ›´æ–‡ä»¶
            
            <details>
            <summary>æŸ¥çœ‹æ‰€æœ‰å˜æ›´æ–‡ä»¶</summary>
            
            ```
            ${{ steps.summary.outputs.changed_files }}
            ```
            
            </details>
            
            ---
            
            ### âœ… æ£€æŸ¥æ¸…å•
            
            - [ ] ä»£ç å·²ç»è¿‡æœ¬åœ°æµ‹è¯•
            - [ ] å·²æ·»åŠ å¿…è¦çš„å•å…ƒæµ‹è¯•
            - [ ] å·²æ›´æ–°ç›¸å…³æ–‡æ¡£
            - [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
            - [ ] æ²¡æœ‰ç ´åæ€§å˜æ›´
            
            ### ğŸ” å®¡æŸ¥è¦ç‚¹
            
            è¯·é‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š
            - ä»£ç è´¨é‡å’Œå¯è¯»æ€§
            - æ€§èƒ½å½±å“
            - å®‰å…¨æ€§è€ƒè™‘
            - å‘åå…¼å®¹æ€§
            
            ---
            
            > ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
            > ğŸ“… åˆ›å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            > ğŸ‘¤ æäº¤è€…: ${{ github.actor }}
          labels: ${{ steps.labels.outputs.labels }}
          draft: false

      - name: Comment on existing PR
        if: steps.check-pr.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ steps.branch-info.outputs.branch_name }}`,
              base: '${{ steps.branch-info.outputs.target_branch }}',
              state: 'open'
            });
            
            if (pulls.length > 0) {
              const pr = pulls[0];
              
              const comment = `## ğŸ”„ æ–°çš„æ¨é€æ£€æµ‹åˆ°
              
              **æ¨é€æ—¶é—´**: \`${{ github.event.head_commit.timestamp }}\`  
              **æäº¤è€…**: @${{ github.actor }}
              
              ### ğŸ“ æœ€æ–°æäº¤
              
              ${{ steps.summary.outputs.commits }}
              
              ### ğŸ“Š ç´¯è®¡å˜æ›´
              
              \`\`\`
              ${{ steps.summary.outputs.stats }}
              \`\`\`
              
              ---
              
              > ğŸ¤– è‡ªåŠ¨æ›´æ–°é€šçŸ¥
              `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

      - name: Request reviewers
        if: steps.check-pr.outputs.result == 'false' && steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            // å¯ä»¥æ ¹æ®éœ€è¦é…ç½®å®¡æŸ¥è€…
            // è¿™é‡Œç•™ç©ºï¼Œæ‚¨å¯ä»¥æ ¹æ®å›¢é˜Ÿæƒ…å†µæ·»åŠ 
            const reviewers = [];
            
            if (reviewers.length > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_request_number: ${{ steps.create-pr.outputs.pull-request-number }},
                reviewers: reviewers
              });
            }

